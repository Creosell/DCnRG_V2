<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-m-8">
    <title>Display Analysis Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #444; }

        /* Main Report Wrapper for Centering and Max-Width */
        .report-wrapper {
            max-width: 1100px;
            margin: 20px auto; /* Центрирует обертку по горизонтали, добавляет отступы сверху/снизу */
            background-color: #fff;
            padding: 20px; /* Внутренние отступы для контента */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        /* Table Styles */
        table { border-collapse: collapse; margin-bottom: 30px; width: 100%;}
        th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: center; }
        th { background-color: #f2f2f2; font-weight: 600; }
        td.param-name { font-weight: 500; color: #222; }

        /* Status Colors */
        .status { font-weight: bold; }
        .status-pass { color: #28a745; }
        .status-fail { color: #dc3545; }
        .status-na { color: #6c757d; }

        /* Plot Section */
        .plot-container { text-align: center; margin-bottom: 20px; }
        .plot-controls { margin-bottom: 15px; }
        .plot-controls label { margin-right: 15px; font-size: 14px; user-select: none; }

        /* SVG Plot Elements */
        #plot-svg { border: 1px solid #ccc; }
        .triangle { fill-opacity: 0.15; stroke-width: 1; }
        #srgb_triangle { fill: #007bff; stroke: #007bff; }
        #ntsc_triangle { fill: #dc3545; stroke: #000000; }
        #device_triangle { fill: #28a745; stroke: #28a745; }

        /* Debug Grid */
        .debug-grid-point { fill: #ff00ff; opacity: 0.7; }

        /* Fail Report */
        .fail-report { font-family: "Courier New", Courier, monospace; font-size: 13px; background-color: #fff; border: 1px solid #eee; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }

        /* New Table for Individual Reports Styling */
        .individual-reports-table {
            font-size: 12px; /* Smaller font for many columns */
            table-layout: auto; /* Allow column width adjustment */
            width: 100%;
        }

        .individual-reports-table th, .individual-reports-table td {
            padding: 8px 6px;
        }

        /* Styles for filter row and inputs (NEW) */
        .filter-cell {
            padding: 5px 6px;
            border-top: none; /* Make the filter row less prominent */
        }

        .filter-cell input {
            width: 100%;
            box-sizing: border-box; /* Include padding/border in width */
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 10px; /* Small font size for compact look */
            text-align: center;
        }

        /* Page Break for printing/PDF generation */
        .page-break {
            page-break-before: always;
        }
    </style>
</head>
<body>
<div class="report-wrapper">
    {% set main_report_names = {
        'Brightness': 'Brightness (cd/m²)',
        'Brightness_uniformity': 'Brightness Uniformity (%)',
        'Cg_rgb_area': 'sRGB Gamut Area (%)',
        'Cg_ntsc_area': 'NTSC Gamut Area (%)',
        'Contrast': 'Contrast Ratio',
        'Temperature': 'Color Temperature (K)',
        'Gamma': 'Gamma (2.2)',
        'Cct_uniformity': 'Color Temp Uniformity (%)',
        'Cg_rgb': 'sRGB Gamut Coverage (%)',       'Cg_ntsc': 'NTSC Gamut Coverage (%)'       } %}

    {% set coord_report_names = {
        'Red_x': 'Red Coord (x)', 'Red_y': 'Red Coord (y)',
        'Green_x': 'Green Coord (x)', 'Green_y': 'Green Coord (y)',
        'Blue_x': 'Blue Coord (x)', 'Blue_y': 'Blue Coord (y)',
        'White_x': 'White Coord (x)', 'White_y': 'White Coord (y)',
        'Center_x': 'Center Coord (x)', 'Center_y': 'Center Coord (y)'
    } %}

    <h1>Display Analysis Report</h1>

    <h2>Main Test Results</h2>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Min (Actual)</th>
                <th>Min (Expected)</th>
                <th>Avg (Actual)</th>
                <th>Typ (Expected)</th>
                <th>Max (Actual)</th>
                <th>Max (Expected)</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in main_report.items() %}
            {% if name in main_report_names %}
            <tr>
                <td class="param-name">{{ main_report_names.get(name, name) }}</td>
                <td>{{ data.actual_values.min | default('N/A') }}</td>
                <td>{{ data.expected_values.min | default('N/A') }}</td>
                <td>{{ data.actual_values.avg | default('N/A') }}</td>
                <td>{{ data.expected_values.typ | default('N/A') }}</td>
                <td>{{ data.actual_values.max | default('N/A') }}</td>
                <td>{{ data.expected_values.max | default('N/A') }}</td>

                {% set status_class = 'status-na' %}
                {% if data.status == 'PASS' %}{% set status_class = 'status-pass' %}
                {% elif data.status == 'FAIL' %}{% set status_class = 'status-fail' %}
                {% endif %}
                <td class="status {{ status_class }}">{{ data.status | default('N/A') }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <h4>Fails description</h4>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in main_report.items() %}
            {% if name in main_report_names %}
                {% if data.status == 'FAIL' %} <tr>
                    <td class="param-name">{{ main_report_names.get(name, name) }}</td>
                    <td>{{ data.reason | default('') }}</td>
                </tr>
                {% endif %}
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <h2>Color Coordinates</h2>
    <table>
        <thead>
            <tr>
                <th>Coordinate</th>
                <th>Min (Actual)</th>
                <th>Avg (Actual)</th>
                <th>Max (Actual)</th>
                <th>Min (Expected)</th>
                <th>Max (Expected)</th>
                <th>Status</th>
                <th>Note</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in main_report.items() %}
            {% if name in coord_report_names %}
            <tr>
                <td class="param-name">{{ coord_report_names.get(name, name) }}</td>
                <td>{{ data.actual_values.min | default('N/A') }}</td>
                <td>{{ data.actual_values.avg | default('N/A') }}</td>
                <td>{{ data.actual_values.max | default('N/A') }}</td>
                <td>{{ data.expected_values.min | default('N/A') }}</td>
                <td>{{ data.expected_values.max | default('N/A') }}</td>

                {% set status_class = 'status-na' %}
                {% if data.status == 'PASS' %}{% set status_class = 'status-pass' %}
                {% elif data.status == 'FAIL' %}{% set status_class = 'status-fail' %}
                {% endif %}
                <td class="status {{ status_class }}">{{ data.status | default('N/A') }}</td>

                <td>{{ data.reason | default('') }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <h2>Color Gamut Plot</h2>
    <div class="plot-container">
        <div class="plot-controls">
            <label><input type="checkbox" onchange="toggleTriangle('device_triangle')" checked> Device</label>
            <label><input type="checkbox" onchange="toggleTriangle('ntsc_triangle')" checked> NTSC</label>
            <label><input type="checkbox" onchange="toggleTriangle('srgb_triangle')" checked> sRGB</label>
<!--            <label><input type="checkbox" onchange="toggleDebugGrid()"> <b>Debug Grid</b></label>-->
        </div>

        <svg id="plot-svg" width="494" height="555" viewBox="0 0 494 525" xmlns="http://www.w3.org/2000/svg">

            <image href="{{ cie_background_svg }}" width="494" height="525" x="0" y="0" />

            {{ raw_svg_background | safe }}

            <polygon id="srgb_triangle" class="triangle" points="{{ srgb_points }}" />
            <polygon id="ntsc_triangle" class="triangle" points="{{ ntsc_points }}" />
            <polygon id="device_triangle" class="triangle" points="{{ device_points }}" />

            <g id="debug_grid" style="display: none;">
                <circle class="debug-grid-point" cx="{{ debug_points.bottom_left[0] }}" cy="{{ debug_points.bottom_left[1] }}" r="5" />
                <circle class="debug-grid-point" cx="{{ debug_points.bottom_right[0] }}" cy="{{ debug_points.bottom_right[1] }}" r="5" />
                <circle class="debug-grid-point" cx="{{ debug_points.top_left[0] }}" cy="{{ debug_points.top_left[1] }}" r="5" />
                <circle class="debug-grid-point" cx="{{ debug_points.top_right[0] }}" cy="{{ debug_points.top_right[1] }}" r="5" />
            </g>
        </svg>
    </div>

    <h2>Fail on Minimum Values Report</h2>
    <div class="fail-report">
        {{ min_fail_data_json }}
    </div>

    <div class="page-break"></div>
<h2 class="individual-reports-header">Raw Results Per Device</h2>

<table id="individual_reports_table" class="individual-reports-table">
    <thead>
        <tr>
            <th class="param-name" style="width: 150px;">Serial Number</th>
            <th style="width: 120px;">Meas. Date/Time</th>
            {% for header in report_headers %}
            <th>{{ header }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for serial_number, report_data in individual_reports.items() %}
        <tr>
            <td class="param-name">{{ serial_number }}</td>
            <td>{{ report_data.measurement_date }}</td>
            {% for header in report_headers %}
            <td>
                {{ report_data.results.get(header, "N/A") }}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

    <script>
        // Toggles the visibility of a specified triangle (sRGB, NTSC, Device)
        function toggleTriangle(id) {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = (el.style.display === 'none') ? 'block' : 'none';
            }
        }

        // Toggles the visibility of the debug grid (4 corner points)
        function toggleDebugGrid() {
            const el = document.getElementById('debug_grid');
            if (el) {
                el.style.display = (el.style.display === 'none') ? 'block' : 'none';
            }
        }
    </script>
</div>
</body>
</html>