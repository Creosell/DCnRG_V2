<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Display Analysis Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #444; }

        /* Main Report Wrapper for Centering and Max-Width */
        .report-wrapper {
            max-width: 1100px;
            margin: 20px auto; /* Центрирует обертку по горизонтали, добавляет отступы сверху/снизу */
            background-color: #fff;
            padding: 20px; /* Внутренние отступы для контента */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        /* Report Header Info */
        .report-header-info {
        text-align: left;
        margin: 10px 0px 0px 0px;
        color: #555;
        font-size: 21px;
        display: inline-grid;
        }
        .report-header-info span {
        display: inline-block;
        }
        .report-header-info strong {
        color: #222;
        }

        /* Report Footer */
        .report-footer {
            margin-top: 50px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: center;
            color: #888;
            font-size: 12px;
        }

        /* Table Styles */
        table { border-collapse: collapse; margin-bottom: 30px; width: 100%;}
        th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: center; }
        th { background-color: #f2f2f2; font-weight: 600; }
        td.param-name { font-weight: 500; color: #222; }

        /* Status Colors */
        .status { font-weight: bold; }
        .status-pass { color: #28a745; }
        .status-fail { color: #dc3545; }
        .status-na { color: #6c757d; }

        /* Plot Section */
        .plot-container { text-align: center; margin-bottom: 20px; }
        .plot-controls { margin-bottom: 15px; }
        .plot-controls label { margin-right: 15px; font-size: 14px; user-select: none; }

        /* === CSS FOR CLICK-TO-ZOOM === */
        #plot-wrapper {
            width: 494px; /* Match SVG width */
            height: 555px; /* Match SVG height */
            overflow: hidden; /* This clips the zoomed SVG */
            margin: auto;
            border: 1px solid #ccc;
            cursor: zoom-in; /* Default cursor: click to zoom in */
            position: relative;
        }

        /* New class for the wrapper to control cursor when zoomed */
        #plot-wrapper.is-zoomed {
            cursor: zoom-out; /* Cursor when zoomed in: click to zoom out */
        }

        #plot-svg {
            /* border: 1px solid #ccc;  <-- Border moved to wrapper */
            border: none;
            transform-origin: center center;
            transition: transform 0.1s ease;
        }

        #plot-svg.zoomed {
            transform: scale(5);
        }
        /* === END CSS FOR ZOOM === */

        /* SVG Plot Elements */
        .triangle { fill-opacity: 0.15; stroke-width: 1; }
        #srgb_triangle { fill: #007bff; stroke: #007bff; }
        #ntsc_triangle { fill: #dc3545; stroke: #000000; }
        #device_triangle { fill: #28a745; stroke: #28a745; }
        #specification_triangle { fill: #007bff; stroke: #7f1a1a; }

        #device_checkbox_label {color: #28a745; }
        #ntsc_checkbox_label {color: #000000; }
        #srgb_checkbox_label {color: #007bff; }
        #specification_checkbox_label {color: #7f1a1a; }

        /* Debug Grid */
        .debug-grid-point { fill: #ff00ff; opacity: 0.7; }

        /* Fail Report */
        .fail-report { font-family: "Courier New", Courier, monospace; font-size: 13px; background-color: #fff; border: 1px solid #eee; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }

        /* New Table for Individual Reports Styling */
        .individual-reports-table {
            font-size: 13px; /* Smaller font for many columns */
            table-layout: auto; /* Allow column width adjustment */
            width: 100%;
        }

        .individual-reports-table th, .individual-reports-table td {
            padding: 8px 14px;
        }

        /* Styling for table with failes by minimum values */
        .min-fail-table {
            font-size: 13px; /* Smaller font for many columns */
            table-layout: auto; /* Allow column width adjustment */
            width: 100%;
        }

        .min-fail-table td, .min-fail-table tr {
            padding: 5px 5px;
        }

        /* === STYLES FOR SORTING === */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-left: 10px;
        }
        /* Default arrow (unsorted) - subtle */
        .sortable-header::after {
            content: ' \2195'; /* Up/Down Arrow */
            opacity: 0.3;
            position: absolute;
            right: 3px;
            padding-left: 10px;
        }
        /* Ascending arrow */
        .sortable-header.sort-asc::after {
            content: ' \25B2'; /* Black Up-Pointing Triangle */
            opacity: 1;
        }
        /* Descending arrow */
        .sortable-header.sort-desc::after {
            content: ' \25BC'; /* Black Down-Pointing Triangle */
            opacity: 1;
        }
        /* === END STYLES FOR SORTING === */


        /* Styles for filter row and inputs (NEW) */
        .filter-cell {
            padding: 5px 6px;
            border-top: none; /* Make the filter row less prominent */
        }

        .filter-cell input {
            width: 100%;
            box-sizing: border-box; /* Include padding/border in width */
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 10px; /* Small font size for compact look */
            text-align: center;
        }

        /* Page Break for printing/PDF generation */
        .page-break {
            page-break-before: always;
        }
    </style>
</head>
<body>
<div class="report-wrapper">
    <h1>Display Analysis Report</h1>
    <div class="report-header-info">
        <span><strong>Device configuration:</strong> {{ current_device_name }}</span>
        <span><strong>Inspection date:</strong> {{ inspection_date }}</span>
    </div>
    <h2>Main Test Results</h2>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Min (Actual)</th>
                <th>Min (Expected)</th>
                <th>Typ (Actual)</th>
                <th>Typ (Expected)</th>
                <th>Max (Actual)</th>
                <th>Max (Expected)</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in main_report.data.items() %}
            <tr>
                <td class="param-name">{{ name }}</td>
                <td>{{ data.actual_values.min | default('N/A') }}</td>
                <td>{{ data.expected_values.min | default('N/A') }}</td>
                <td>{{ data.actual_values.avg | default('N/A') }}</td>
                <td>{{ data.expected_values.typ | default('N/A') }}</td>
                <td>{{ data.actual_values.max | default('N/A') }}</td>
                <td>{{ data.expected_values.max | default('N/A') }}</td>

                {% set status_class = 'status-na' %}
                {% if data.status == 'PASS' %}{% set status_class = 'status-pass' %}
                {% elif data.status == 'FAIL' %}{% set status_class = 'status-fail' %}
                {% endif %}
                <td class="status {{ status_class }}">{{ data.status | default('N/A') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h4>Fails description</h4>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in main_report.data.items() %}
                {% if data.status == 'FAIL' %} <tr>
                    <td class="param-name">{{ name }}</td>
                    <td>{{ data.reason | default('') }}</td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <h2>Color Coordinates</h2>
    <table>
        <thead>
            <tr>
                <th>Coordinate</th>
                <th>Min (Actual)</th>
                <th>Min (Expected)</th>
                <th>Typ (Actual)</th>
                <th>Typ (Expected)</th>
                <th>Max (Actual)</th>
                <th>Max (Expected)</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in main_report.coordinates.items() %}
            <tr>
                <td class="param-name">{{ name }}</td>
                <td>{{ data.actual_values.min | default('N/A') }}</td>
                <td>{{ data.expected_values.min | default('N/A') }}</td>
                <td>{{ data.actual_values.avg | default('N/A') }}</td>
                <td>{{ data.expected_values.typ | default('N/A') }}</td>
                <td>{{ data.actual_values.max | default('N/A') }}</td>
                <td>{{ data.expected_values.max | default('N/A') }}</td>

                {% set status_class = 'status-na' %}
                {% if data.status == 'PASS' %}{% set status_class = 'status-pass' %}
                {% elif data.status == 'FAIL' %}{% set status_class = 'status-fail' %}
                {% endif %}
                <td class="status {{ status_class }}">{{ data.status | default('N/A') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h4>Fails description</h4>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in main_report.coordinates.items() %}
                {% if data.status == 'FAIL' %} <tr>
                    <td class="param-name">{{ name }}</td>
                    <td>{{ data.reason | default('') }}</td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <h2>Color Gamut Plot</h2>
    <div class="plot-container">
        <div class="plot-controls">
            <label id="ntsc_checkbox_label"><input type="checkbox" onchange="toggleTriangle('ntsc_triangle')" checked> NTSC</label>
            <label id="srgb_checkbox_label"><input type="checkbox" onchange="toggleTriangle('srgb_triangle')" checked> sRGB</label>
            <label id="device_checkbox_label"><input type="checkbox" onchange="toggleTriangle('device_triangle')" checked> Device</label>
            <label id="specification_checkbox_label"><input type="checkbox" onchange="toggleTriangle('specification_triangle')" > Specification</label>
        </div>

        <div id="plot-wrapper">
            <svg id="plot-svg" width="494" height="555" viewBox="0 0 494 525" xmlns="http://www.w3.org/2000/svg">

                <image href="{{ cie_background_svg }}" width="494" height="525" x="0" y="0" />

                {{ raw_svg_background | safe }}

                <polygon id="srgb_triangle" class="triangle" points="{{ summary_plot_points.srgb }}" />
                <polygon id="ntsc_triangle" class="triangle" points="{{ summary_plot_points.ntsc }}" />
                <polygon id="device_triangle" class="triangle" points="{{ summary_plot_points.device }}" />
                <polygon id="specification_triangle" class="triangle" points="{{ summary_plot_points.specification }}" style="display: none;"/>

                <g id="debug_grid" style="display: none;">
                    <circle class="debug-grid-point" cx="{{ summary_plot_points.debug.bottom_left[0] }}" cy="{{ summary_plot_points.debug.bottom_left[1] }}" r="5" />
                    <circle class="debug-grid-point" cx="{{ summary_plot_points.debug.bottom_right[0] }}" cy="{{ summary_plot_points.debug.bottom_right[1] }}" r="5" />
                    <circle class="debug-grid-point" cx="{{ summary_plot_points.debug.top_left[0] }}" cy="{{ summary_plot_points.debug.top_left[1] }}" r="5" />
                    <circle class="debug-grid-point" cx="{{ summary_plot_points.debug.top_right[0] }}" cy="{{ summary_plot_points.debug.top_right[1] }}" r="5" />
                </g>
            </svg>
        </div>
    </div>

<h2>Fail on Minimum Values Report</h2>

    {% if min_fail_grouped %}
    <table id="min_fail_table" class="min-fail-table">
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Expected Min Limit</th>
                <th>Serial Number</th>
                <th>Actual Min Value</th>
            </tr>
        </thead>
        <tbody>
            {% for param_name, failures in min_fail_grouped.items() %}
                {# Sort failures by SN for consistency #}
                {% for fail in failures|sort(attribute='sn') %}
                <tr>
                    {# Show Parameter Name and Limit only once per group using rowspan #}
                    {% if loop.first %}
                        <td rowspan="{{ loop.length }}" style="vertical-align: middle; font-weight: 600; background-color: #fff;">
                            {{ param_name }}
                        </td>
                        <td rowspan="{{ loop.length }}" style="vertical-align: middle; background-color: #fff;">
                            {{ fail.expected_min }}
                        </td>
                    {% endif %}

                    <td class="param-name">{{ fail.sn }}</td>
                    <td class="status status-fail">{{ fail.min_value }}</td>
                </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 20px; text-align: center; color: #28a745; font-weight: 500; border: 1px solid #ddd; border-radius: 4px; background-color: #fff;">
        No failures detected on minimum values.
    </div>
    {% endif %}

    <div class="page-break"></div>

    <h2 class="individual-reports-header">Device reports - Main Data</h2>
    <table id="individual_reports_table_main" class="individual-reports-table">
        <thead id="individual-table-head-main">
            <tr>
                <th class="sortable-header" style="width: 150px;" onclick="sortTable('main', 0)">Serial Number</th>
                <th class="sortable-header" style="width: 120px;" onclick="sortTable('main', 1)">Meas. Date/Time</th>
                {% set first_device = device_reports.data.values() | first %}
                {% set master_keys_main = first_device.results.keys() | list %}
                {% for header in master_keys_main %}
                <th class="sortable-header" onclick="sortTable('main', {{ loop.index0 + 2 }})">{{ header }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody id="individual-table-body-main">
            {% for serial_number, report_data in device_reports.data.items() %}
            <tr>
                <td class="param-name">{{ serial_number }}</td>
                <td>{{ report_data.measurement_date }}</td>
                {% for key in master_keys_main %}
                <td>
                    {{ report_data.results.get(key, "N/A") }}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 class="individual-reports-header">Device reports - Coordinates</h2>
    <table id="individual_reports_table_coords" class="individual-reports-table">
        <thead id="individual-table-head-coords">
            <tr>
                <th class="sortable-header" style="width: 150px;" onclick="sortTable('coords', 0)">Serial Number</th>
                <th class="sortable-header" style="width: 120px;" onclick="sortTable('coords', 1)">Meas. Date/Time</th>
                {% set first_device = device_reports.coordinates.values() | first %}
                {% set master_keys_coords = first_device.results.keys() | list %}
                {% for header in master_keys_coords %}
                <th class="sortable-header" onclick="sortTable('coords', {{ loop.index0 + 2 }})">{{ header }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody id="individual-table-body-coords">
            {% for serial_number, report_data in device_reports.coordinates.items() %}
            <tr>
                <td class="param-name">{{ serial_number }}</td>
                <td>{{ report_data.measurement_date }}</td>
                {% for key in master_keys_coords %}
                <td>
                    {{ report_data.results.get(key, "N/A") }}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="report-footer">
        Generated by Report Generator v{{ app_version }}
    </div>


    <script>
        // Toggles the visibility of a specified triangle (sRGB, NTSC, Device)
        function toggleTriangle(id) {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = (el.style.display === 'none') ? 'block' : 'none';
            }
        }

        // Toggles the visibility of the debug grid (4 corner points)
        function toggleDebugGrid() {
            const el = document.getElementById('debug_grid');
            if (el) {
                el.style.display = (el.style.display === 'none') ? 'block' : 'none';
            }
        }

        // === JAVASCRIPT FOR ZOOM (без изменений) ===
        window.addEventListener('DOMContentLoaded', (event) => {
            const wrapper = document.getElementById('plot-wrapper');
            const svg = document.getElementById('plot-svg');
            if (!wrapper || !svg) return; // Safety check

            // 1. Click: Toggle zoom and set origin
            wrapper.addEventListener('click', (e) => {
                svg.classList.toggle('zoomed');
                wrapper.classList.toggle('is-zoomed');

                if (svg.classList.contains('zoomed')) {
                    const rect = wrapper.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    svg.style.transformOrigin = `${x}px ${y}px`;
                } else {
                    svg.style.transformOrigin = 'center center';
                }
            });

            // 2. Mouse leaves: Always reset zoom
            wrapper.addEventListener('mouseleave', () => {
                svg.classList.remove('zoomed');
                wrapper.classList.remove('is-zoomed');
                svg.style.transformOrigin = 'center center';
            });

            // 3. Mouse move: Update the zoom origin (panning)
            wrapper.addEventListener('mousemove', (e) => {
                if (svg.classList.contains('zoomed')) {
                    const rect = wrapper.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    svg.style.transformOrigin = `${x}px ${y}px`;
                }
            });

            // === JAVASCRIPT MODIFICATION: Table Sorting Logic ===

            // Store current sort direction (now an object for multiple tables)
            let sortDirections = {
                'main': {},
                'coords': {}
            };

            // Helper function to parse values
            function parseValue(val, dir) {
                // Push "N/A" or "None" to the bottom regardless of sort direction
                if (val === 'N/A' || val === 'None' || val.trim() === '') {
                    return dir === 'asc' ? Infinity : -Infinity;
                }
                // Try to convert to number
                const num = parseFloat(val.replace(',', '.')); // Handle decimal commas
                // If it's not a number, return lowercase string. Otherwise, return the number.
                return isNaN(num) ? val.toLowerCase() : num;
            }

            // Main sort function (now takes tableSuffix)
            window.sortTable = function(tableSuffix, colIndex) {
                const tbody = document.getElementById('individual-table-body-' + tableSuffix);
                const thead = document.getElementById('individual-table-head-' + tableSuffix);
                if (!tbody || !thead) return;

                const rows = Array.from(tbody.querySelectorAll('tr'));

                // Determine direction (toggle or default to 'asc')
                const currentDir = sortDirections[tableSuffix][colIndex];
                const dir = currentDir === 'asc' ? 'desc' : 'asc';

                // Reset directions for this table
                sortDirections[tableSuffix] = {};
                // Set direction for the clicked column
                sortDirections[tableSuffix][colIndex] = dir;

                // Sort the rows
                rows.sort((rowA, rowB) => {
                    const cellA = rowA.querySelectorAll('td')[colIndex].innerText;
                    const cellB = rowB.querySelectorAll('td')[colIndex].innerText;

                    const valA = parseValue(cellA, dir);
                    const valB = parseValue(cellB, dir);

                    let comparison = 0;
                    if (valA > valB) {
                        comparison = 1;
                    } else if (valA < valB) {
                        comparison = -1;
                    }

                    return dir === 'asc' ? comparison : -comparison;
                });

                // Update visual arrows
                const headers = thead.querySelectorAll('.sortable-header');
                headers.forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
                headers[colIndex].classList.add(dir === 'asc' ? 'sort-asc' : 'sort-desc');

                // Re-append sorted rows to the tbody
                rows.forEach(row => tbody.appendChild(row));
            }

            // Default sort by Serial Number (Column 0) on page load FOR BOTH tables
            sortTable('main', 0);
            sortTable('coords', 0);

        }); // End DOMContentLoaded
        // === END JAVASCRIPT MODIFICATION ===
    </script>
</div>
</body>
</html>