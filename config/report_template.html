<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-m-8">
    <title>Display Analysis Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #444; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: 600; }
        td.param-name { font-weight: 500; color: #222; }

        /* Status Colors */
        .status { font-weight: bold; }
        .status-pass { color: #28a745; }
        .status-fail { color: #dc3545; }
        .status-na { color: #6c757d; }

        /* Plot Section */
        .plot-container { text-align: center; margin-bottom: 20px; }
        .plot-controls { margin-bottom: 15px; }
        .plot-controls label { margin-right: 15px; font-size: 14px; user-select: none; }

        /* SVG Plot Elements */
        #plot-svg { border: 1px solid #ccc; }
        .triangle { fill-opacity: 0.15; stroke-width: 1; }
        #srgb_triangle { fill: #007bff; stroke: #007bff; }
        #ntsc_triangle { fill: #dc3545; stroke: #dc3545; }
        #device_triangle { fill: #28a745; stroke: #28a745; }

        /* Debug Grid */
        .debug-grid-point { fill: #ff00ff; opacity: 0.7; }

        /* Fail Report */
        .fail-report { font-family: "Courier New", Courier, monospace; font-size: 13px; background-color: #fff; border: 1px solid #eee; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>

    <h1>Display Analysis Report</h1>

    <h2>Main Test Results</h2>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Min (Actual)</th>
                <th>Min (Expected)</th>
                <th>Avg (Actual)</th>
                <th>Typ (Expected)</th>
                <th>Max (Actual)</th>
                <th>Max (Expected)</th>
                <th>Status</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in main_report.items() %}
            {% if name in ['Brightness', 'Brightness_uniformity', 'Cg_rgb_area', 'Cg_ntsc_area', 'Contrast', 'Temperature'] %}
            <tr>
                <td classclass="param-name">{{ name }}</td>
                <td>{{ data.actual_values.min | default('N/A') }}</td>
                <td>{{ data.expected_values.min | default('N/A') }}</td>
                <td>{{ data.actual_values.avg | default('N/A') }}</td>
                <td>{{ data.expected_values.typ | default('N/A') }}</td>
                <td>{{ data.actual_values.max | default('N/A') }}</td>
                <td>{{ data.expected_values.max | default('N/A') }}</td>

                {% set status_class = 'status-na' %}
                {% if data.status == 'PASS' %}{% set status_class = 'status-pass' %}
                {% elif data.status == 'FAIL' %}{% set status_class = 'status-fail' %}
                {% endif %}
                <td class="status {{ status_class }}">{{ data.status | default('N/A') }}</td>

                <td>{{ data.reason }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <h2>Color Coordinates</h2>
    <table>
        <thead>
            <tr>
                <th>Coordinate</th>
                <th>Min (Actual)</th>
                <th>Avg (Actual)</th>
                <th>Max (Actual)</th>
                <th>Min (Expected)</th>
                <th>Max (Expected)</th>
                <th>Status</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in main_report.items() %}
            {% if name in ['Red_x', 'Red_y', 'Green_x', 'Green_y', 'Blue_x', 'Blue_y', 'White_x', 'White_y', 'Center_x', 'Center_y'] %}
            <tr>
                <td class="param-name">{{ name }}</td>
                <td>{{ data.actual_values.min | default('N/A') }}</td>
                <td>{{ data.actual_values.avg | default('N/A') }}</td>
                <td>{{ data.actual_values.max | default('N/A') }}</td>
                <td>{{ data.expected_values.min | default('N/A') }}</td>
                <td>{{ data.expected_values.max | default('N/A') }}</td>

                {% set status_class = 'status-na' %}
                {% if data.status == 'PASS' %}{% set status_class = 'status-pass' %}
                {% elif data.status == 'FAIL' %}{% set status_class = 'status-fail' %}
                {% endif %}
                <td class="status {{ status_class }}">{{ data.status | default('N/A') }}</td>

                <td>{{ data.reason }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <h2>Color Gamut Plot</h2>
    <div class="plot-container">
        <div class="plot-controls">
            <label><input type="checkbox" onchange="toggleTriangle('srgb_triangle')" checked> sRGB</label>
            <label><input type="checkbox" onchange="toggleTriangle('ntsc_triangle')" checked> NTSC</label>
            <label><input type="checkbox" onchange="toggleTriangle('device_triangle')" checked> Device</label>
            <label><input type="checkbox" onchange="toggleDebugGrid()"> <b>Debug Grid</b></label>
        </div>

        <svg id="plot-svg" width="494" height="555" viewBox="0 0 494 525" xmlns="http://www.w3.org/2000/svg">

            <image href="{{ cie_background_svg }}" width="494" height="525" x="0" y="0" />

            {{ raw_svg_background | safe }}

            <polygon id="srgb_triangle" class="triangle" points="{{ srgb_points }}" />
            <polygon id="ntsc_triangle" class="triangle" points="{{ ntsc_points }}" />
            <polygon id="device_triangle" class="triangle" points="{{ device_points }}" />

            <g id="debug_grid" style="display: none;">
                <circle class="debug-grid-point" cx="{{ debug_points.bottom_left[0] }}" cy="{{ debug_points.bottom_left[1] }}" r="5" />
                <circle class="debug-grid-point" cx="{{ debug_points.bottom_right[0] }}" cy="{{ debug_points.bottom_right[1] }}" r="5" />
                <circle class="debug-grid-point" cx="{{ debug_points.top_left[0] }}" cy="{{ debug_points.top_left[1] }}" r="5" />
                <circle class="debug-grid-point" cx="{{ debug_points.top_right[0] }}" cy="{{ debug_points.top_right[1] }}" r="5" />
            </g>
        </svg>
    </div>

    <h2>Fail on Minimum Values Report</h2>
    <div class="fail-report">
        {{ min_fail_data_json }}
    </div>

    <script>
        function toggleTriangle(id) {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = (el.style.display === 'none') ? 'block' : 'none';
            }
        }

        function toggleDebugGrid() {
            const el = document.getElementById('debug_grid');
            if (el) {
                el.style.display = (el.style.display === 'none') ? 'block' : 'none';
            }
        }
    </script>

</body>
</html>